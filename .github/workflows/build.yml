name: Build Keyhunt

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-macos-arm64:
    name: macOS Apple Silicon (M1/M2/M3)
    runs-on: macos-14  # Apple Silicon runner

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        brew install openssl@3 gmp

    - name: Configure CMake
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_OSX_ARCHITECTURES=arm64 \
          -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3) \
          -DKEYHUNT_APPLE_SILICON_ONLY=ON

    - name: Build
      run: cmake --build build --config Release -j $(sysctl -n hw.ncpu)

    - name: Test binary
      run: |
        ./build/keyhunt -h || true
        file ./build/keyhunt

    - name: Upload keyhunt
      uses: actions/upload-artifact@v4
      with:
        name: keyhunt-macos-arm64
        path: build/keyhunt

    - name: Upload bsgsd
      uses: actions/upload-artifact@v4
      with:
        name: bsgsd-macos-arm64
        path: build/bsgsd

  build-macos-x64:
    name: macOS Intel (x64) - Compatibility Build
    runs-on: macos-13  # Intel runner

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        brew install openssl@3 gmp

    - name: Configure CMake
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_OSX_ARCHITECTURES=x86_64 \
          -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3) \
          -DKEYHUNT_APPLE_SILICON_ONLY=OFF

    - name: Build
      run: cmake --build build --config Release -j $(sysctl -n hw.ncpu)

    - name: Upload keyhunt (Intel)
      uses: actions/upload-artifact@v4
      with:
        name: keyhunt-macos-x64
        path: build/keyhunt

  build-linux-cuda:
    name: Linux CUDA (GPU Accelerated)
    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v4

    - name: Install CUDA Toolkit
      uses: Jimver/cuda-toolkit@v0.2.14
      with:
        cuda: '12.2.0'
        method: 'network'
        sub-packages: '["nvcc", "cudart"]'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libssl-dev libgmp-dev libomp-dev

    - name: Configure CMake with CUDA
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DKEYHUNT_USE_CUDA=ON \
          -DKEYHUNT_APPLE_SILICON_ONLY=OFF \
          -DCMAKE_CUDA_ARCHITECTURES="75;80;86;89"

    - name: Build
      run: cmake --build build --config Release -j $(nproc)

    - name: Test binary
      run: |
        ./build/keyhunt -h || true
        file ./build/keyhunt

    - name: Upload keyhunt (CUDA)
      uses: actions/upload-artifact@v4
      with:
        name: keyhunt-linux-cuda
        path: build/keyhunt

    - name: Upload bsgsd (CUDA)
      uses: actions/upload-artifact@v4
      with:
        name: bsgsd-linux-cuda
        path: build/bsgsd

  build-linux-cpu:
    name: Linux CPU Only
    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libssl-dev libgmp-dev libomp-dev

    - name: Configure CMake
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DKEYHUNT_USE_CUDA=OFF \
          -DKEYHUNT_APPLE_SILICON_ONLY=OFF

    - name: Build
      run: cmake --build build --config Release -j $(nproc)

    - name: Upload keyhunt (Linux CPU)
      uses: actions/upload-artifact@v4
      with:
        name: keyhunt-linux-cpu
        path: build/keyhunt

  release:
    needs: [build-macos-arm64, build-macos-x64, build-linux-cuda, build-linux-cpu]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')

    steps:
    - name: Download macOS ARM64 artifact
      uses: actions/download-artifact@v4
      with:
        name: keyhunt-macos-arm64
        path: macos-arm64

    - name: Download macOS x64 artifact
      uses: actions/download-artifact@v4
      with:
        name: keyhunt-macos-x64
        path: macos-x64

    - name: Download Linux CUDA artifact
      uses: actions/download-artifact@v4
      with:
        name: keyhunt-linux-cuda
        path: linux-cuda

    - name: Download Linux CPU artifact
      uses: actions/download-artifact@v4
      with:
        name: keyhunt-linux-cpu
        path: linux-cpu

    - name: Rename artifacts
      run: |
        mv macos-arm64/keyhunt keyhunt-macos-arm64
        mv macos-x64/keyhunt keyhunt-macos-x64
        mv linux-cuda/keyhunt keyhunt-linux-cuda
        mv linux-cpu/keyhunt keyhunt-linux-cpu

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          keyhunt-macos-arm64
          keyhunt-macos-x64
          keyhunt-linux-cuda
          keyhunt-linux-cpu
        body: |
          ## Keyhunt - Bitcoin Puzzle Hunter

          ### Downloads
          | Platform | File | Notes |
          |----------|------|-------|
          | macOS Apple Silicon | `keyhunt-macos-arm64` | M1/M2/M3/M4 optimized |
          | macOS Intel | `keyhunt-macos-x64` | For Intel Macs |
          | Linux CUDA | `keyhunt-linux-cuda` | NVIDIA GPU accelerated |
          | Linux CPU | `keyhunt-linux-cpu` | CPU-only version |

          ### Quick Start
          ```bash
          chmod +x keyhunt-*
          # CPU mode
          ./keyhunt-macos-arm64 -m bsgs -f tests/66.txt -b 66 -t 8 -R
          # GPU mode (Linux CUDA)
          ./keyhunt-linux-cuda -m bsgs -f tests/66.txt -b 66 --gpu -g 0 -R
          ```
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
