name: Build Keyhunt

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

# NOTE: macOS builds are disabled because secp256k1/Int.h uses x86-specific
# intrinsics (__builtin_ia32_*) that don't work on ARM64 or with Clang on macOS.
# The code needs significant refactoring for cross-platform support.
# For now, only Linux x86_64 builds are supported.

jobs:
  build-linux-cpu:
    name: Linux CPU Only
    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libssl-dev libgmp-dev libomp-dev

    - name: Configure CMake
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DKEYHUNT_USE_CUDA=OFF \
          -DKEYHUNT_APPLE_SILICON_ONLY=OFF

    - name: Build
      run: cmake --build build --config Release -j $(nproc)

    - name: Test binary
      run: |
        ./build/keyhunt -h || true
        file ./build/keyhunt

    - name: Upload keyhunt (Linux CPU)
      uses: actions/upload-artifact@v4
      with:
        name: keyhunt-linux-cpu
        path: build/keyhunt

    - name: Upload bsgsd (Linux CPU)
      uses: actions/upload-artifact@v4
      with:
        name: bsgsd-linux-cpu
        path: build/bsgsd

  release:
    needs: [build-linux-cpu]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')

    steps:
    - name: Download Linux CPU artifact
      uses: actions/download-artifact@v4
      with:
        name: keyhunt-linux-cpu
        path: linux-cpu

    - name: Download bsgsd artifact
      uses: actions/download-artifact@v4
      with:
        name: bsgsd-linux-cpu
        path: bsgsd-cpu

    - name: Rename artifacts
      run: |
        mv linux-cpu/keyhunt keyhunt-linux-x64
        mv bsgsd-cpu/bsgsd bsgsd-linux-x64

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          keyhunt-linux-x64
          bsgsd-linux-x64
        body: |
          ## Keyhunt - Bitcoin Puzzle Hunter

          ### Downloads
          | Platform | File | Notes |
          |----------|------|-------|
          | Linux x64 | `keyhunt-linux-x64` | CPU version (CUDA: build from source) |
          | Linux x64 | `bsgsd-linux-x64` | BSGS daemon |

          ### Quick Start
          ```bash
          chmod +x keyhunt-linux-x64
          ./keyhunt-linux-x64 -m bsgs -f tests/66.txt -b 66 -t 8 -R
          ```

          ### Build with CUDA (for GPU)
          ```bash
          cmake -B build -DKEYHUNT_USE_CUDA=ON
          cmake --build build -j$(nproc)
          ```
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
